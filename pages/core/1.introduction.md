# 架构介绍 Introduction

<!-- ![流程图.jpg](../assets/infrastructure.png) -->

```mermaid
block-beta
    columns 16

    app["业务应用"]:1
    block:b_a:15
        app_app["Business Application"]
    end

    fre["业务/社区继承的框架"]
    block:b_fre:15
        fr_eggjs_echo["@egg/echo"]
        fr_ant_fw["ForAntGroup Private FW"]
        fr_bytedance_fw["ForBytedanc Private FW"]
        fr_nio_fw["ForNIOGroup Private FW"]
    end

    frb["上层框架"]
    block:b_frb:15
        columns 4

        frb_egg_web["@eggjs/web"]
        block:b_frb_egg_web
            space
            egg_web_confjs_http["@confjs/http"]
            egg_web_confjs_body["@confjs/body"]
        end

        frb_egg_websocket["@eggjs/websocket"]
        block:b_frb_egg_websocket
            space
            egg_websocket_confjs_ws["@confjs/ws"]
            egg_websocket_eggjs_keep_alive["@eggjs/keep-alive"]
        end

        frb_gulux_web["@gulux/web"]
        block:b_frb_gulux_web
            space
            gulux_web_confjs_http["@confjs/http"]
            gulux_web_confjs_body["@confjs/body"]
        end

        frb_gulux_rpc["@gulux/rpc"]
        block:b_frb_gulux_rpc
            space
            gulux_rpc_byted_rpc["@byted/rpc"]
            gulux_rpc_gulux_tracing["@gulux/tracing"]
        end

        frb_nio_bff_api["@nio/bff-api"]
        block:b_frb_nio_bff_api
            space
            nio_bff_api_confjs_http["@confjs/http"]
            nio_bff_api_nio_kong_body["@nio/kong-body"]
        end

        frb_nio_mq["@nio/mq-customer"]
        block:b_frb_nio_mq
            space
            nio_mq_nio_queue["@nio/queue"]
            nio_mq_confjs_kafka["@confjs/kafka"]
        end
    end

    fr["上层框架(防腐层)"]
    block:b_fr:15
        columns 4

        fr_egg["Egg.js"]
        block:b_fr_egg
            space
            egg_cli["CLI"]
            egg_more["兼容代码"]
        end

        fr_gulu_x["GuluX"]
        block:b_fr_gulu_x
            space
            gulux_cli["CLI"]
            gulux_more["兼容代码"]
        end

        fr_artusx["ArtusX"]
        block:b_fr_artus_x
            space
            artusx_cli["CLI"]
            artusx_more["兼容代码"]
        end

        fr_nio_base["NIO Node.js Base Framework"]
        block:b_fr_nio_base
            space
            nio_base_cli["CLI"]
            nio_base_more["兼容代码"]
        end
    end

    p["基础插件"]:1
    block:b_p:15
        loader basePlugin pipeline framework
    end

classDef plugin fill:#ffeebb;
classDef framework fill:#969;
class loader,basePlugin,pipeline,framework plugin
```

```mermaid
flowchart BT
    subgraph plugin_base [基础插件]
      direction TB
      loader
      pipeline
      plugin
      framework
    end

    subgraph framework_base [上层框架]
      direction TB

      subgraph egg_base [Egg.js]
        direction TB
        egg_cli[CLI]
        egg_more[兼容代码]
      end

      subgraph gulu_x [GuluX]
        direction TB
        gulux_cli[CLI]
        gulux_more[兼容代码]
      end

      subgraph artus_x [ArtusX]
        direction TB
        artusx_cli[CLI]
        artusx_more[兼容代码]
      end

      subgraph nio_base [NIO Node.js Base Framework]
        direction TB
        nio_cli[CLI]
        nio_more[兼容代码]
      end
    end

    subgraph framework_core [上层框架]
      direction TB

      subgraph egg_web [@eggjs/web]
        direction LR
        egg_web_confjs_http[@confjs/http]
        egg_web_confjs_body[@confjs/body]
      end

      subgraph egg_websocket [@eggjs/websocket]
        direction LR
        egg_websocket_confjs_ws[@confjs/ws]
        egg_websocket_eggjs_keep_alive[@eggjs/keep-alive]
      end

      subgraph gulux_web [@gulux/web]
        direction LR
        gulux_web_confjs_http[@confjs/http]
        gulux_web_confjs_body[@confjs/body]
      end

      subgraph gulux_rpc [@gulux/rpc]
        direction LR
        gulux_rpc_byted_rpc[@byted/rpc]
        gulux_rpc_gulux_tracing[@gulux/tracing]
      end

      subgraph nio_bff_api [@nio/bff-api]
        direction LR
        nio_bff_api_confjs_http[@confjs/http]
        nio_bff_api_nio_kong_body[@nio/kong-body]
      end

      subgraph nio_mq [@nio/mq-customer]
        direction LR
        nio_mq_confjs_kafka[@confjs/kafka]
        nio_mq_nio_queue[@nio/queue]
      end

    end

    subgraph framework_extend [业务/社区继承框架]
      direction TB
      fr_eggjs_echo[@egg/echo]
      fr_ant_fw[ForAntGroup Private FW]
      fr_bytedance_fw[ForBytedanc Private FW]
      fr_nio_fw[ForNIOGroup Private FW]
    end

    subgraph application [业务应用]
      direction LR
      business_application[Business Application]
    end

    plugin_base -.- framework_base -.- framework_core -.- framework_extend -.- application
```

（上图仅用于表达相关组件的层级关系，与各商业公司的基础设施和具体实现无关）

## 设计理念

在已有的大规模 Node.js 应用实践中会发现，跨团队/部门间往往会存在一些相似的基建 SDK 与通用逻辑集合，仅依靠一个个离散的 npm 包级别的封装难以进行有效的应用治理。

因此会天然存在需求：需要有对应的设计对这些通用逻辑集合进行存放和统一的管理。这样，一个不具备框架级别复用能力的框架本身就无法在大规模的 Node.js 应用中铺开。

既能进行统一的通用逻辑治理，又能满足各个业务团队本地化定制的需求，面向框架的框架设计应运而生。

## 架构分层

参照 OOP 语言的继承，将框架设计立体化，垂直的继承链路可以很方便处理不同的业务团队对通用逻辑集合的存放和统一的管理需求。

由于通用逻辑集合本身往往是一组封装好的原子 npm 模块，因此框架的继承又会有别于 OOP 语言的继承：可以将多个业务上平级的框架各自管理的通用逻辑集合进行合并。

最后需要在垂直的框架继承链路之外增加水平的框架切面插槽，满足进一步的扩展需求。

因此根据职能边界，进行以下的结构分层

- `application`：应用，具备独立部署且提供完整能力的最小单位
- `plugin`：插件，对中间件缺失的应用生命周期通用能力的补充，也可以认为是对应用通用能力的扩展
- `framework`：框架，提供业务逻辑无关的一组基础能力透出，可以认为是一组插件的集合

其中`application`、`plugin` 和 `framework` 之间的关系如下：

<!-- ![组件关系](../assets/framework-relation.png) -->

```mermaid
flowchart LR
    subgraph framework_base
      direction TB
      plugin_a
      plugin_b
    end

    subgraph framework_core
      direction TB
      plugin_c
      plugin_d
    end

    subgraph application_base
      direction TB
      plugin_e
      plugin_f
    end

    framework_base --> framework_core --> application_base
```

`framework` 是一组插件能力的集合，仅提供如下能力：

- 一组插件的管理
- 通用配置

框架也可以通过继承的方式进行层层递进式扩展，另外需要通过切面的方式支持在 application 对任意垂直继承链路中的平级框架进行替换：

<!-- ![框架扩展](../assets/framework-extend.png)-->

```mermaid
flowchart BT
    subgraph framework [Framework 2]
      direction TB
      plugin_a
      plugin_b
    end

    subgraph framework_1 [Framework 1-1]
      direction TB
      plugin_c
    end

    subgraph framework_2 [Framework 1]
      direction TB
      plugin_d
    end

    subgraph framework_3 [Framework 1-2]
      direction TB
      plugin_e
    end

    application([Application])

    framework --> framework_1 -.- application
    framework --> framework_2 --> application
    framework --> framework_3  -.- application
```

垂直继承 + 水平切面插槽打造的立体化框架设计，即可从容面对千变万化的 Node.js 研发场景。
